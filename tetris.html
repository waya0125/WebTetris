<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
</head>
<style>

*{
  padding: 0;
  margin: 0;
}

/* ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºå ´æ‰€ã®å¤§ãã•ã¨ã‹ */
#display {
  width: calc(24px * 12);
  height: calc(24px * 22);
}

/* 1ãƒã‚¹ã®å¤§ãã•ã¨ã‹è‰²(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ é»’) */
.cell {
  width: 22px;
  height: 22px;
  display:block;
  float: left;
  background-color: rgb(32, 32, 32);
  border-left: 1px solid rgb(64, 64, 64);
  border-top: 1px solid rgb(64, 64, 64);
  border-right: 1px solid rgb(16, 16, 16);
  border-bottom: 1px solid rgb(16, 16, 16);
}

/* å¤–å´ã®å£ç”¨ã®ãƒã‚¹ã®è‰²(ç°è‰²) */
.wall {
  background-color: rgb(128, 128, 128);
  border-left: 1px solid rgb(192, 192, 192);
  border-top: 1px solid rgb(192, 192, 192);
  border-right: 1px solid rgb(64, 64, 64);
  border-bottom: 1px solid rgb(64, 64, 64);
}

/* æ°´è‰² */
.I {
  background-color: #3399ff;
  border-left: 1px solid #99ccff;
  border-top: 1px solid #99ccff;
  border-right: 1px solid #0066ff;
  border-bottom: 1px solid #0066ff;
}

/* ç´«è‰² */
.T {
  background-color: #cc33cc;
  border-left: 1px solid #cc66cc;
  border-top: 1px solid #cc66cc;
  border-right: 1px solid #cc00cc;
  border-bottom: 1px solid #cc00cc;
}

/* é»„è‰² */
.O {
  background-color: #ccff00;
  border-left: 1px solid #ffff00;
  border-top: 1px solid #ffff00;
  border-right: 1px solid #99cc00;
  border-bottom: 1px solid #99cc00;
}

/* èµ¤è‰² */
.Z {
  background-color: #ff0033;
  border-left: 1px solid #cc3366;
  border-top: 1px solid #cc3366;
  border-right: 1px solid #cc0033;
  border-bottom: 1px solid #cc0033;
}

/* é»„ç·‘è‰² */
.S {
  background-color: #66cc33;
  border-left: 1px solid #99ff66;
  border-top: 1px solid #99ff66;
  border-right: 1px solid #339900;
  border-bottom: 1px solid #339900;
}

/* ã‚ªãƒ¬ãƒ³ã‚¸è‰² */
.L {
  background-color: #ff6600;
  border-left: 1px solid #ff9966;
  border-top: 1px solid #ff9966;
  border-right: 1px solid #cc6633;
  border-bottom: 1px solid #cc6633;
}

/* é’è‰² */
.J {
  background-color: #0033cc;
  border-left: 1px solid #0066ff;
  border-top: 1px solid #0066ff;
  border-right: 1px solid #000099;
  border-bottom: 1px solid #000099;
}

/* ãƒœã‚¿ãƒ³ */
#rotate, #left, #up, #right, #down {
  width: 48px;
  height: 48px;
  font-size: 32px;
}
</style>
<body> 

  <!-- è¡¨ç¤ºå ´æ‰€ -->
  <div id="display"></div>
  <div id="buttons">
    <input type="button" id="rotate" value="ğŸ”">
    <input type="button" id="left" value="â†">
    <input type="button" id="up" value="â†‘">
    <input type="button" id="right" value="â†’">
    <input type="button" id="down" value="â†“">
  </div>

<script>


// ãƒ–ãƒ­ãƒƒã‚¯ã®ã§ãƒ¼ãŸ 
function Block(x, y, type) {
  this.x = x;
  this.y = y;
  this.type = type;
  this.status = 0;
}
var block = new Block(4, 0, Math.floor(Math.random() * (7)));

let field_width = 12;
let field_height = 22;
let Cell = {
  None : 0,
  Wall : 1,
  I : 2,
  O : 3,
  S : 4,
  Z : 5,
  J : 6,
  L : 7,
  T : 8,
};
// ã‚«ã‚¦ãƒ³ã‚¿
var cnt = 0;

// å‡ºåŠ›ç”¨ãƒ¡ãƒ¢ãƒª
var vram = [
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1],
  ];

// ã‚²ãƒ¼ãƒ ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
var field = [
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1],
  ];

// å„ãƒ–ãƒ­ãƒƒã‚¯ã®çŠ¶æ…‹ã®æ•° - 1
let block_status = [1, 0, 1, 1, 3, 3, 3]
// å„ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ ¼ç´ã™ã‚‹
let blocks = [
  [ // I
    [
      [Cell.I,Cell.I,Cell.I,Cell.I]
    ],
    [
      [Cell.I],
      [Cell.I],
      [Cell.I],
      [Cell.I]
    ]
  ],
  [ // O
    [
      [Cell.O,Cell.O],
      [Cell.O,Cell.O]
    ]
  ],
  [ // S
    [
      [Cell.S,Cell.None],
      [Cell.S,Cell.S],
      [Cell.None,Cell.S]
    ],
    [
      [Cell.None,Cell.S,Cell.S],
      [Cell.S,Cell.S,Cell.None]
    ]
  ],
  [ // Z
    [
      [Cell.None,Cell.Z],
      [Cell.Z,Cell.Z],
      [Cell.Z,Cell.None]
    ],
    [
      [Cell.Z,Cell.Z,Cell.None],
      [Cell.None,Cell.Z,Cell.Z]
    ]
  ],
  [ // J
    [
      [Cell.None,Cell.J],
      [Cell.None,Cell.J],
      [Cell.J,Cell.J]
    ],
    [
      [Cell.J,Cell.None,Cell.None],
      [Cell.J,Cell.J,Cell.J]
    ],
    [
      [Cell.J,Cell.J],
      [Cell.J,Cell.None],
      [Cell.J,Cell.None]
    ],
    [
      [Cell.J,Cell.J,Cell.J],
      [Cell.None,Cell.None,Cell.J]
    ]
  ],
  [ // L
    [
      [Cell.L,Cell.None],
      [Cell.L,Cell.None],
      [Cell.L,Cell.L]
    ],
    [
      [Cell.L,Cell.L,Cell.L],
      [Cell.L,Cell.None,Cell.None]
    ],
    [
      [Cell.L,Cell.L],
      [Cell.None,Cell.L],
      [Cell.None,Cell.L]
    ],
    [
      [Cell.None,Cell.None,Cell.L],
      [Cell.L,Cell.L,Cell.L]
    ]
  ],
  [ // T
    [
      [Cell.T,Cell.None],
      [Cell.T,Cell.T],
      [Cell.T,Cell.None]
    ],
    [
      [Cell.T,Cell.T,Cell.T],
      [Cell.None,Cell.T,Cell.None]
    ],
    [
      [Cell.None,Cell.T],
      [Cell.T,Cell.T],
      [Cell.None,Cell.T]
    ],
    [
      [Cell.None,Cell.T,Cell.None],
      [Cell.T,Cell.T,Cell.T]
    ]
  ]
];

// é…åˆ—ã‚³ãƒ”ãƒ¼
// sa : ã‚³ãƒ”ãƒ¼å…ƒé…åˆ—
// da : ã‚³ãƒ”ãƒ¼å…ˆé…åˆ—
// sx : ã‚³ãƒ”ãƒ¼å…ƒã®xåº§æ¨™
// sy : ã‚³ãƒ”ãƒ¼å…ƒã®yåº§æ¨™
// dx : ã‚³ãƒ”ãƒ¼å…ˆã®xåº§æ¨™
// dy : ã‚³ãƒ”ãƒ¼å…ˆã®yåº§æ¨™
// width : ã‚³ãƒ”ãƒ¼ã™ã‚‹å¹…
// height : ã‚³ãƒ”ãƒ¼ã™ã‚‹é«˜ã•
// ignore : ã‚³ãƒ”ãƒ¼ã—ãªã„å€¤
let copy = function(sa, da, sx, sy, dx, dy, ignore) {
  let width = sa[0].length;
  let height = sa.length;
  for(var i = 0; i < height; i++) {
    for(var j = 0; j < width; j++) {
      if(sa[sy + i][sx + j] == ignore) continue;
      da[dy + i][dx + j] = sa[sy + i][sx + j];
    }
  }
};

// btypeã§statusãªãƒ–ãƒ­ãƒƒã‚¯ãŒ(x, y)ãªåº§æ¨™ã«è¨­ç½®ã§ãã‚‹ã‹
let checkOkeru = function(btype, status, x, y) {
  console.log("status => " + status);
  var b = blocks[btype][status];
  let w = b[0].length;
  let h = b.length;
  for(var i = y; i < y + h; i++) {
    for(var j = x; j < x + w; j++) {
      if(b[i-y][j-x] == Cell.None) continue;
      if(field[i][j] != Cell.None) return false;
    }
  }
  return true;
};

// vramã‚’displayã¸å‡ºåŠ›(vram to html)
let disp = function() {
  let d = document.getElementById("display"); // å‡ºåŠ›å ´æ‰€ã®è¦ç´ ã‚’å–å¾—

  var s = ""; // displayã¸æ›¸ãè¾¼ã‚€htmlã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°

  for(var i = 0; i < field_height; i++) {
    for(var j = 0; j < field_width; j++) {
      s += "<div class='cell ";
      switch(vram[i][j]) {
      case Cell.Wall: s += "wall"; break;
      case Cell.I: s += "I"; break;
      case Cell.O: s += "O"; break;
      case Cell.S: s += "S"; break;
      case Cell.Z: s += "Z"; break;
      case Cell.J: s += "J"; break;
      case Cell.L: s += "L"; break;
      case Cell.T: s += "T"; break;
      case Cell.None: break;
      }
      s += "'></div>";
    }
  }

  d.innerHTML = s; // è¦ç´ ã«æ›¸ãè¾¼ã¿
}; 

// æç”»é–¢ä¿‚
let graph = function() {
  copy(field, vram, 0, 0, 0, 0, -1, 0); // vramã«fieldã‚’ã‚³ãƒ”ãƒ¼
  copy(blocks[block.type][block.status], vram, 0, 0, block.x, block.y, 0); // vramã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼
  disp();
};

// å‡¦ç†
let process = function() {
  if(checkOkeru(block.type, block.status, block.x, block.y + 1)) block.y++; // ç½®ã‘ã‚‹
  else next();  // ç½®ã‘ãªã„
};

// yè¡Œç›®ã‚’æ¶ˆã—ã¦ä¸Šã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸‹ã’ã‚‹
let delline = function(y) {
  for(var i = y; i > 0; i--) {
    for(var j = 1; j < field_width - 1; j++) {
      field[i][j] = field[i-1][j];
    }
  }
};

// ç½®ã‘ãªããªã£ãŸã‚‰
let next = function() {  
  // fieldã«å›ºå®š
  copy(blocks[block.type][block.status], field, 0, 0, block.x, block.y, 0);
  graph();
  
  // æ¶ˆã›ã‚‹è¡ŒãŒã‚ã‚‹ã‹èª¿ã¹ã‚‹
  for(var i = 0; i < field_height - 1; i++){
    var cnt = 0;
    for(var j = 0; j < field_width; j++){
      cnt++;
      if(field[i][j] == Cell.None) break;
    }
    if(cnt == field_width) delline(i);
  }
  // æ¬¡ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç™»éŒ²
  block.type = Math.floor(Math.random() * (7));
  block.x = 4;
  block.y = 0;
  block.status = 0;
};

// main loop
let loop = function() {
  console.log(cnt++);
  graph();
  process();
  setTimeout(loop, 1000);
};

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("left").addEventListener("click", function() {
  if(checkOkeru(block.type, block.status, block.x - 1, block.y)) block.x--;
});

document.getElementById("up").addEventListener("click", function() {
  while(checkOkeru(block.type, block.status, block.x, block.y + 1)){
    block.y++;
  }
  next();
});

document.getElementById("down").addEventListener("click", function() {
  process();
});

document.getElementById("right").addEventListener("click", function() {
  if(checkOkeru(block.type, block.status, block.x + 1, block.y)) block.x++;
});

document.getElementById("rotate").addEventListener("click", function() {block.status++;
  if(block.status > block_status[block.type]) block.status = 0;
  if(!checkOkeru(block.type, block.status, block.x, block.y)){
    block.status--;
    if(block.status < 0) block.status = block_status[block.type];
  }
});

// ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener("keydown", function(e) {
  console.log("keycode = " + e.keyCode);
  switch(e.keyCode) {
  case 37: // â†
    if(checkOkeru(block.type, block.status, block.x - 1, block.y)) block.x--; // å·¦ã«å‹•ã‹ã›ã‚‹ãªã‚‰å‹•ã‹ã™
    break;
  case 38:  // â†‘
    while(checkOkeru(block.type, block.status, block.x, block.y + 1)){  //  ä¸‹ã¾ã§å‹•ã‹ã™
      block.y++;
    }
    next();
    break;
  case 39: // â†’
    if(checkOkeru(block.type, block.status, block.x + 1, block.y)) block.x++; // å³ã«å‹•ã‹ã›ã‚‹ãªã‚‰å‹•ã‹ã™
    break;
  case 40: // â†“
    process();  // ä¸‹ã«å‹•ã‹ã›ã‚‹ãªã‚‰å‹•ã‹ã™
    break;
  case 65: // 'a'
    // å·¦ã«å›è»¢ã§ãã‚‹ãªã‚‰å›è»¢ã™ã‚‹
    block.status--;
    if(block.status < 0) block.status = block_status[block.type];
    if(!checkOkeru(block.type, block.status, block.x, block.y)) {
      block.status++;
      if(block.status > block_status[block.type]) block.status = 0;
    }
    break;
  case 83: // 's'
    // å³ã«å›è»¢ã§ãã‚‹ãªã‚‰å›è»¢ã™ã‚‹
    block.status++;
    if(block.status > block_status[block.type]) block.status = 0;
    if(!checkOkeru(block.type, block.status, block.x, block.y)){
      block.status--;
      if(block.status < 0) block.status = block_status[block.type];
    }
    break;
  }
  console.log("block_status => " + block.status);
  graph();
});

loop(); // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œ

</script>
</body>
</html>
